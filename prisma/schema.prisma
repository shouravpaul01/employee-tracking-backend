generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id     String     @id @default(auto()) @map("_id") @db.ObjectId
  name   String
  email  String     @unique
  phone  String?
  photo  String?
  role   UserRole   @default(EMPLOYEE)
  status UserStatus @default(ACTIVE)

  isDeleted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignedEmployees AssignedEmployee[]
  credential        Credential?
  expenses          Expenses[]

  // receiver relation
  notifications Notification[]

  //  sender relation (IMPORTANT)
  sentNotifications Notification[] @relation("NotificationSender")

  @@map("users")
}

model Credential {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  password    String
  otp         String?
  otpExpireAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userId String @unique @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  @@map("credentials")
}

model Project {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  name       String @unique
  clientName String

  propertyAddress String
  accessInfo      String?
  notes           String?
  status          ProjectStatus @default(PENDING)

  lastWorkingDate    DateTime?
  walkthroughVideo   String?
  stagedVideo        String?
  beforeDestageVideo String?
  destagedVideo      String?
  photos             String[]           @default([])
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  expenses           Expenses[]
  assignedEmployees  AssignedEmployee[]

  @@index([clientName, status, lastWorkingDate])
  @@map("projects")
}

model AssignedEmployee {
  id             String               @id @default(auto()) @map("_id") @db.ObjectId
  role           AssignedEmployeeRole
  checkIn        DateTime?
  checkOut       DateTime?
  breakTimeStart DateTime?
  breakTimeEnd   DateTime?
  status         AttendanceStatus     @default(NOT_STARTED)
  projectId      String               @db.ObjectId
  project        Project              @relation(fields: [projectId], references: [id])
  employeeId     String               @db.ObjectId
  employee       User                 @relation(fields: [employeeId], references: [id])
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@index([createdAt])
  @@map("assigned_employees")
}

model Expenses {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  category        String
  projectId       String         @db.ObjectId
  project         Project        @relation(fields: [projectId], references: [id])
  employeeId      String         @db.ObjectId
  employee        User           @relation(fields: [employeeId], references: [id])
  amount          Float
  description     String?
  receiptDocImage String?
  status          ExpensesStatus @default(PENDING)
  feedback        String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("expenses")
}

model Notification {
  id      String           @id @default(auto()) @map("_id") @db.ObjectId
  title   String
  message String
  type    NotificationType

  // optional reference (deep linking)
  referenceId   String?        @db.ObjectId
  referenceType ReferenceType?

  //  Receiver
  receiverId String @db.ObjectId
  receiver   User   @relation(fields: [receiverId], references: [id])

  //  Sender 
  senderId String? @db.ObjectId
  sender   User?   @relation("NotificationSender", fields: [senderId], references: [id])

  isRead Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([receiverId, isRead])
  @@map("notifications")
}

enum NotificationType {
  EXPENSE
  PROJECT
  ATTENDANCE
  SYSTEM
}

enum ReferenceType {
  PROJECT
  EXPENSE
  ASSIGNMENT
}

enum ExpensesStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AttendanceStatus {
  NOT_STARTED
  CHECKED_IN
  ON_BREAK
  BREAK_ENDED
  CHECKED_OUT
}

enum AssignedEmployeeRole {
  RUNNER
  PICKER
}

enum ProjectStatus {
  PENDING
  STAGING
  WALKTHROUGH
  BEFOREDESTAGE
  DESTAGING
  COMPLETED
}

enum UserRole {
  ADMIN
  EMPLOYEE
}

enum UserStatus {
  ACTIVE
  BLOCKED
}
